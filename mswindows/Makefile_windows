# MingW Makefile for the mswindows subdirectory
# This Makefile is intended to create the PyTables Pro installer for Windows

VERSIONFILE=..\VERSION
VERSION=$(shell type ..\VERSION)

ifeq ($(PYTHONVERSION), 24)
	DOTPYTHONVERSION=2.4
endif
ifeq ($(PYTHONVERSION), 25)
	DOTPYTHONVERSION=2.5
endif

ifeq ($(LICENSE), site)
	LICENSEFILE=..\LICENSE-site.txt
	LICENSEFILENAME=LICENSE-site.txt
endif
ifeq ($(LICENSE), personal)
	LICENSEFILE=..\LICENSE-personal.txt
	LICENSEFILENAME=LICENSE-personal.txt
endif


# The NSIS intstaller script
VTNSIS=vitables-py$(DOTPYTHONVERSION).nsi

# Required paths
SVN_VITABLES=..
MISDOCS="C:\Documents and Settings\vmas\Mis documentos"
WINDOWS32=C:\\Windows\\system32
QTDIR=C:\\Qt\\3.3.6
PYQTDIR=C:\\Python$(PYTHONVERSION)\\pyqt_for_vitables_installer
MINGWDIR=C:\\MinGW
VENDORID=$(MISDOCS)\VendorID-1.0.0

.PHONY: vitables.exe

clean:
	$(MAKE) -f Makefile_windows -C ..\doc $@
	del $(VTNSIS)
	del ViTables*.win32-py$(DOTPYTHONVERSION).exe
	del vitables.exe
	del LICENSE.html

vitables.exe:
	copy $(SVN_VITABLES)\scripts\vitables $(VENDORID)\sib\vitables.py
	C:\Python$(PYTHONVERSION)\python $(VENDORID)\sib\sib.py -M -i $(SVN_VITABLES)\icons\vitables.ico -d $(VENDORID)\sib\build_vitables $(VENDORID)\sib\vitables.py
	$(MAKE) -C $(VENDORID)\sib\build_vitables
	copy $(VENDORID)\sib\build_vitables\vitables.exe .
	del /q /s $(VENDORID)\sib\build_vitables
	del $(VENDORID)\sib\vitables.py
	rmdir $(VENDORID)\sib\build_vitables

installer: vitables.nsi.in $(VERSIONFILE) $(LICENSEFILE) vitables.exe
	$(MAKE) -f Makefile_windows -C ..\doc
	copy ..\LICENSE-$(LICENSE).html LICENSE.html
	type vitables.nsi.in | sed -e "s/@VERSION@/$(VERSION)/g" \
	-e "s/@PYTHONVERSION@/$(PYTHONVERSION)/g" \
	-e "s/@DOTPYTHONVERSION@/$(DOTPYTHONVERSION)/g" \
	-e "s/@SVN_VITABLES@/$(SVN_VITABLES)/g" \
	-e "s/@MINGWDIR@/$(MINGWDIR)/g" \
	-e "s/@QTDIR@/$(QTDIR)/g" \
	-e "s/@PYQTDIR@/$(PYQTDIR)/g" \
	-e "s/@WINDOWS32@/$(WINDOWS32)/g" \
	-e "s/@LICENSE@/$(LICENSE)/g" \
	-e "s/@LICENSEFILENAME@/$(LICENSEFILENAME)/g" \
	> $(VTNSIS)
	makensis $(VTNSIS)
