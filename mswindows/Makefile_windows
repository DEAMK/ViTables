# MingW Makefile for the mswindows subdirectory
# This Makefile is intended to create the ViTables installer for Windows.
# It is not intended for distribution.

VERSIONFILE=..\VERSION
VERSION=$(shell type ..\VERSION)

PYTHONVERSION=25
DOTPYTHONVERSION=2.5

ROOT=..
LICENSEFILE=$(ROOT)\LICENSE.txt
LICENSEFILENAME=LICENSE.txt
WINDOWS32=C:\\Windows\\system32

# The NSIS intstaller script
VTNSIS=vitables-py$(DOTPYTHONVERSION).nsi

# ViTables executable. sib.py understands forward slashes
PYTHON=C:/Python$(PYTHONVERSION)/python
SIB="C:/Documents and Settings/vmas/Mis documentos/VendorID-1.0.0/sib"
ICONS="$(ROOT)/vitables/icons"

# Documentation. Docbook understands forward slashes
GUIDE_SRC="$(ROOT)/doc/usersguide.xml"
HTML_OPTIONS=--nonet --stringparam base.dir $(ROOT)/doc/htmldocs/
HTML_STYLE=C:/docbook-xsl-1.75.2/html/chunk.xsl
FO_OPTIONS=--nonet -o $(ROOT)/doc/usersguide.fo
FO_STYLE=C:/docbook-xsl-1.75.2/fo/docbook.xsl
OUTDIR=$(ROOT)\doc\htmldocs

clean:
	del $(ROOT)\vitables.py
	rmdir /q /s $(OUTDIR)
	del $(ROOT)\doc\usersguide.pdf
	del $(VTNSIS)
	del ViTables*.win32-py$(DOTPYTHONVERSION).exe

vitables.exe:
	copy $(ROOT)\scripts\vitables .\vitables.py
	$(PYTHON) $(SIB)/sib.py -M -u -i $(ICONS)/vitables.ico ./vitables.py
	$(MAKE) -C build_vitables
	copy build_vitables\vitables.exe .
	del /q /s build_vitables
	del .\vitables.py
	rmdir build_vitables

vtdoc:
	xsltproc $(HTML_OPTIONS) $(HTML_STYLE) $(GUIDE_SRC)
	mkdir $(OUTDIR)\images
	copy $(ROOT)\doc\images\* $(OUTDIR)\images
	copy $(ROOT)\LICENSE.html $(OUTDIR)
	xsltproc $(FO_OPTIONS) $(FO_STYLE) $(GUIDE_SRC)
	fop -q $(ROOT)/doc/usersguide.fo $(ROOT)/doc/usersguide.pdf
	del $(ROOT)\doc\usersguide.fo

installer: vitables.nsi.in $(VERSIONFILE) $(LICENSEFILE) vitables.exe vtdoc
	copy ..\LICENSE.html LICENSE.html
	type vitables.nsi.in | sed -e "s/@VERSION@/$(VERSION)/g" \
	-e "s/@PYTHONVERSION@/$(PYTHONVERSION)/g" \
	-e "s/@DOTPYTHONVERSION@/$(DOTPYTHONVERSION)/g" \
	-e "s/@ROOT@/$(ROOT)/g" \
	-e "s/@WINDOWS32@/$(WINDOWS32)/g" \
	-e "s/@LICENSE@/$(LICENSE)/g" \
	-e "s/@LICENSEFILENAME@/$(LICENSEFILENAME)/g" \
	> $(VTNSIS)
	makensis $(VTNSIS)
	del LICENSE.html
	del vitables.exe
