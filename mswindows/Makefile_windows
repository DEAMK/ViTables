# MingW Makefile for the mswindows subdirectory
# This Makefile is intended to create the ViTables installer for Windows.
# It is not intended for distribution.

VERSIONFILE=..\VERSION
VERSION=$(shell type ..\VERSION)

PYTHONVERSION=25
DOTPYTHONVERSION=2.5

LICENSEFILE=..\LICENSE.txt
LICENSEFILENAME=LICENSE.txt


# The NSIS intstaller script
VTNSIS=vitables-py$(DOTPYTHONVERSION).nsi

# Required paths
REPO_VITABLES=..
MISDOCS="C:\Documents and Settings\vmas\Mis documentos"
WINDOWS32=C:\\Windows\\system32
PYQTDIR=C:\\Python$(PYTHONVERSION)\\pyqt4_for_vitables_installer
MINGWDIR=C:\\MinGW
VENDORID=$(MISDOCS)\VendorID-1.0.0

.PHONY: vitables.exe

clean:
	del $(VTNSIS)
	del ViTables*.win32-py$(DOTPYTHONVERSION).exe
	del vitables.exe
	del LICENSE.html
	$(MAKE) -f Makefile_windows -C ..\doc $@

vitables.exe:
	copy $(REPO_VITABLES)\scripts\vitables $(VENDORID)\sib\vitables.py
	C:\Python$(PYTHONVERSION)\python $(VENDORID)\sib\sib.py -u -M -i $(REPO_VITABLES)\icons\vitables.ico -d $(VENDORID)\sib\build_vitables $(VENDORID)\sib\vitables.py
	$(MAKE) -C $(VENDORID)\sib\build_vitables
	copy $(VENDORID)\sib\build_vitables\vitables.exe .
	del /q /s $(VENDORID)\sib\build_vitables
	del $(VENDORID)\sib\vitables.py
	rmdir $(VENDORID)\sib\build_vitables

doc:
	$(MAKE) -f Makefile_windows -C ..\doc all

resources:
	$(MAKE) -f Makefile -C .. $@

installer: vitables.nsi.in $(VERSIONFILE) $(LICENSEFILE) vitables.exe doc resources
	copy ..\LICENSE.html LICENSE.html
	type vitables.nsi.in | sed -e "s/@VERSION@/$(VERSION)/g" \
	-e "s/@PYTHONVERSION@/$(PYTHONVERSION)/g" \
	-e "s/@DOTPYTHONVERSION@/$(DOTPYTHONVERSION)/g" \
	-e "s/@REPO_VITABLES@/$(REPO_VITABLES)/g" \
	-e "s/@MINGWDIR@/$(MINGWDIR)/g" \
	-e "s/@PYQTDIR@/$(PYQTDIR)/g" \
	-e "s/@WINDOWS32@/$(WINDOWS32)/g" \
	-e "s/@LICENSE@/$(LICENSE)/g" \
	-e "s/@LICENSEFILENAME@/$(LICENSEFILENAME)/g" \
	> $(VTNSIS)
	makensis $(VTNSIS)
